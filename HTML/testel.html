<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test API - PetZone</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background: #f5f5f5;
        }
        h1 {
            color: #23906F;
            text-align: center;
        }
        .test-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        button {
            background: #23906F;
            color: white;
            border: none;
            padding: 1rem 2rem;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            margin-right: 1rem;
            margin-bottom: 1rem;
        }
        button:hover {
            background: #1d7559;
        }
        pre {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 8px;
            overflow-x: auto;
            border-left: 4px solid #23906F;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .result {
            margin-top: 1rem;
        }
        .product-card {
            border: 1px solid #ddd;
            padding: 1rem;
            margin: 1rem 0;
            border-radius: 8px;
            display: flex;
            gap: 1rem;
            align-items: center;
        }
        .product-card img {
            width: 100px;
            height: 100px;
            object-fit: contain;
            border-radius: 8px;
            background: #f5f5f5;
        }
        .product-info {
            flex: 1;
        }
        .status {
            padding: 0.5rem 1rem;
            border-radius: 5px;
            display: inline-block;
            margin-top: 1rem;
        }
        .status.ok {
            background: #d4edda;
            color: #155724;
        }
        .status.fail {
            background: #f8d7da;
            color: #721c24;
        }
    </style>
</head>
<body>
    <h1>üß™ Test de Conexi√≥n API - PetZone</h1>
    
    <!-- TEST 1: PRODUCTOS -->
    <div class="test-section">
        <h2>1Ô∏è‚É£ Test: Cargar Productos</h2>
        <button onclick="testProductos()">üöÄ Probar API Productos</button>
        <div id="resultProductos" class="result"></div>
    </div>

    <!-- TEST 2: CATEGOR√çAS -->
    <div class="test-section">
        <h2>2Ô∏è‚É£ Test: Cargar Categor√≠as</h2>
        <button onclick="testCategorias()">üöÄ Probar API Categor√≠as</button>
        <div id="resultCategorias" class="result"></div>
    </div>

    <!-- TEST 3: FILTRADO -->
    <div class="test-section">
        <h2>3Ô∏è‚É£ Test: Filtrar por Categor√≠a</h2>
        <button onclick="testFiltrado('comida')">üçñ Comida</button>
        <button onclick="testFiltrado('juguetes')">üéæ Juguetes</button>
        <button onclick="testFiltrado('aseo')">üßº Aseo</button>
        <button onclick="testFiltrado('antipulgas')">üêõ Antipulgas</button>
        <button onclick="testFiltrado('accesorios')">ü¶¥ Accesorios</button>
        <div id="resultFiltrado" class="result"></div>
    </div>

    <!-- TEST 4: IM√ÅGENES -->
    <div class="test-section">
        <h2>4Ô∏è‚É£ Test: Verificar Rutas de Im√°genes</h2>
        <button onclick="testImagenes()">üñºÔ∏è Verificar Im√°genes</button>
        <div id="resultImagenes" class="result"></div>
    </div>

    <script>
        const API_URL = '../api/productos.php';
        const CAT_API_URL = '../api/categorias.php';

        // TEST 1: PRODUCTOS
        async function testProductos() {
            const div = document.getElementById('resultProductos');
            div.innerHTML = '<p>‚è≥ Cargando...</p>';
            
            try {
                const response = await fetch(`${API_URL}?action=list`);
                const data = await response.json();
                
                if (data.success && data.productos) {
                    const total = data.productos.length;
                    const activos = data.productos.filter(p => p.activo == 1).length;
                    const conStock = data.productos.filter(p => p.stock > 0).length;
                    
                    div.innerHTML = `
                        <div class="status ok">‚úÖ API FUNCIONA CORRECTAMENTE</div>
                        <h3>Estad√≠sticas:</h3>
                        <ul>
                            <li><strong>Total de productos:</strong> ${total}</li>
                            <li><strong>Productos activos:</strong> ${activos}</li>
                            <li><strong>Con stock disponible:</strong> ${conStock}</li>
                        </ul>
                        <h3>Primeros 3 productos:</h3>
                        ${data.productos.slice(0, 3).map(p => `
                            <div class="product-card">
                                <img src="../${p.imagen}" onerror="this.src='../IMG/no-image.png'">
                                <div class="product-info">
                                    <strong>${p.nombre}</strong><br>
                                    Categor√≠a: ${p.categoria_nombre}<br>
                                    Precio: S/. ${p.precio}<br>
                                    Stock: ${p.stock}
                                </div>
                            </div>
                        `).join('')}
                        <details>
                            <summary>Ver JSON completo</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    throw new Error('No hay productos');
                }
            } catch (error) {
                div.innerHTML = `
                    <div class="status fail">‚ùå ERROR</div>
                    <p class="error">${error.message}</p>
                    <p>Verifica:</p>
                    <ul>
                        <li>Que Apache y MySQL est√©n corriendo</li>
                        <li>La ruta de la API: <code>${API_URL}</code></li>
                        <li>Que existan productos en la BD</li>
                    </ul>
                `;
            }
        }

        // TEST 2: CATEGOR√çAS
        async function testCategorias() {
            const div = document.getElementById('resultCategorias');
            div.innerHTML = '<p>‚è≥ Cargando...</p>';
            
            try {
                const response = await fetch(CAT_API_URL);
                const data = await response.json();
                
                if (data.success && data.categorias) {
                    const tieneAccesorios = data.categorias.some(c => c.slug === 'accesorios');
                    
                    div.innerHTML = `
                        <div class="status ok">‚úÖ API FUNCIONA CORRECTAMENTE</div>
                        <h3>Categor√≠as encontradas:</h3>
                        <ul>
                            ${data.categorias.map(c => `
                                <li>
                                    <strong>${c.nombre}</strong> (${c.slug})
                                    ${c.slug === 'accesorios' ? ' üéØ <span style="color: #28a745;">¬°Nueva!</span>' : ''}
                                </li>
                            `).join('')}
                        </ul>
                        ${tieneAccesorios 
                            ? '<p class="success">‚úÖ Categor√≠a "Accesorios" detectada</p>' 
                            : '<p class="error">‚ö†Ô∏è Falta categor√≠a "Accesorios" - Ejecutar SQL de actualizaci√≥n</p>'}
                        <details>
                            <summary>Ver JSON completo</summary>
                            <pre>${JSON.stringify(data, null, 2)}</pre>
                        </details>
                    `;
                } else {
                    throw new Error('No hay categor√≠as');
                }
            } catch (error) {
                div.innerHTML = `
                    <div class="status fail">‚ùå ERROR</div>
                    <p class="error">${error.message}</p>
                `;
            }
        }

        // TEST 3: FILTRADO
        async function testFiltrado(categoria) {
            const div = document.getElementById('resultFiltrado');
            div.innerHTML = `<p>‚è≥ Filtrando por "${categoria}"...</p>`;
            
            try {
                const response = await fetch(`${API_URL}?action=list`);
                const data = await response.json();
                
                if (data.success) {
                    const filtered = data.productos.filter(p => p.categoria_slug === categoria);
                    
                    div.innerHTML = `
                        <div class="status ok">‚úÖ Filtrado exitoso</div>
                        <h3>Categor√≠a: ${categoria}</h3>
                        <p><strong>Productos encontrados:</strong> ${filtered.length}</p>
                        ${filtered.length > 0 ? `
                            <ul>
                                ${filtered.slice(0, 5).map(p => `
                                    <li>${p.nombre} - S/. ${p.precio} (Stock: ${p.stock})</li>
                                `).join('')}
                                ${filtered.length > 5 ? `<li><em>... y ${filtered.length - 5} m√°s</em></li>` : ''}
                            </ul>
                        ` : `<p class="error">‚ö†Ô∏è No hay productos en esta categor√≠a</p>`}
                    `;
                } else {
                    throw new Error('Error al filtrar');
                }
            } catch (error) {
                div.innerHTML = `
                    <div class="status fail">‚ùå ERROR</div>
                    <p class="error">${error.message}</p>
                `;
            }
        }

        // TEST 4: IM√ÅGENES
        async function testImagenes() {
            const div = document.getElementById('resultImagenes');
            div.innerHTML = '<p>‚è≥ Verificando im√°genes...</p>';
            
            try {
                const response = await fetch(`${API_URL}?action=list`);
                const data = await response.json();
                
                if (data.success) {
                    const sinImagen = data.productos.filter(p => !p.imagen || p.imagen === '');
                    const rutasIncorrectas = data.productos.filter(p => 
                        p.imagen && !p.imagen.startsWith('IMG/')
                    );
                    
                    const correctas = data.productos.length - sinImagen.length - rutasIncorrectas.length;
                    
                    div.innerHTML = `
                        <div class="status ${sinImagen.length === 0 && rutasIncorrectas.length === 0 ? 'ok' : 'fail'}">
                            ${sinImagen.length === 0 && rutasIncorrectas.length === 0 ? '‚úÖ' : '‚ö†Ô∏è'} Verificaci√≥n completa
                        </div>
                        <h3>Resultados:</h3>
                        <ul>
                            <li><strong>Rutas correctas:</strong> ${correctas} productos</li>
                            <li><strong>Sin imagen:</strong> ${sinImagen.length} productos</li>
                            <li><strong>Rutas incorrectas:</strong> ${rutasIncorrectas.length} productos</li>
                        </ul>
                        ${sinImagen.length > 0 ? `
                            <h4>‚ö†Ô∏è Productos sin imagen:</h4>
                            <ul>${sinImagen.map(p => `<li>${p.nombre} (ID: ${p.id})</li>`).join('')}</ul>
                        ` : ''}
                        ${rutasIncorrectas.length > 0 ? `
                            <h4>‚ö†Ô∏è Productos con ruta incorrecta:</h4>
                            <ul>${rutasIncorrectas.map(p => `<li>${p.nombre}: ${p.imagen}</li>`).join('')}</ul>
                            <p class="error">Ejecutar SQL de correcci√≥n de rutas</p>
                        ` : ''}
                    `;
                } else {
                    throw new Error('Error al obtener productos');
                }
            } catch (error) {
                div.innerHTML = `
                    <div class="status fail">‚ùå ERROR</div>
                    <p class="error">${error.message}</p>
                `;
            }
        }
    </script>
</body>
</html>