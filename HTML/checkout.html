<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Checkout - PetZone</title>
    <link href="https://fonts.googleapis.com/css2?family=Material+Icons&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../css/checkout.css">
</head>
<body>
    <!-- HEADER -->
    <header class="header">
        <div class="header-content">
            <a href="../index.html" class="logo">üêæ PetZone</a>
            <span style="color: var(--text-light);">Checkout Seguro</span>
        </div>
    </header>

    <!-- CHECKOUT -->
    <div class="checkout-container">
        <!-- STEPPER -->
        <div class="stepper">
            <div class="step active" data-step="1">
                <div class="step-circle">1</div>
                <div class="step-label">Informaci√≥n de Env√≠o</div>
            </div>
            <div class="step" data-step="2">
                <div class="step-circle">2</div>
                <div class="step-label">M√©todo de Pago</div>
            </div>
            <div class="step" data-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">Resumen del Pedido</div>
            </div>
        </div>

        <!-- PASO 1: INFORMACI√ìN DE ENV√çO -->
        <section class="checkout-section active" id="step1">
            <h2 class="section-title">
                <span class="material-icons" style="vertical-align: middle;">local_shipping</span>
                Informaci√≥n de Env√≠o
            </h2>

            <form id="shippingForm">
                <div class="form-grid">
                    <div class="form-group">
                        <label>Nombre Completo <span class="required">*</span></label>
                        <input type="text" id="nombre" required>
                        <span class="error-message" id="error-nombre"></span>
                    </div>

                    <div class="form-group">
                        <label>Tel√©fono <span class="required">*</span></label>
                        <input type="tel" id="telefono" placeholder="9XX XXX XXX" maxlength="9" required>
                        <span class="error-message" id="error-telefono"></span>
                    </div>

                    <div class="form-group full-width">
                        <label>Correo Electr√≥nico <span class="required">*</span></label>
                        <input type="email" id="email" required>
                        <span class="error-message" id="error-email"></span>
                    </div>

                    <div class="form-group">
                        <label>Departamento <span class="required">*</span></label>
                        <select id="departamento" required>
                            <option value="">Seleccionar...</option>
                            <option value="Lima">Lima</option>
                            <option value="Arequipa">Arequipa</option>
                            <option value="Cusco">Cusco</option>
                            <option value="La Libertad">La Libertad</option>
                        </select>
                        <span class="error-message" id="error-departamento"></span>
                    </div>

                    <div class="form-group">
                        <label>Distrito <span class="required">*</span></label>
                        <select id="distrito" required disabled>
                            <option value="">Primero selecciona departamento</option>
                        </select>
                        <span class="error-message" id="error-distrito"></span>
                    </div>

                    <div class="form-group full-width">
                        <label>Direcci√≥n Completa <span class="required">*</span></label>
                        <textarea id="direccion" rows="3" placeholder="Calle, n√∫mero, urbanizaci√≥n, referencias..." required></textarea>
                        <span class="error-message" id="error-direccion"></span>
                    </div>
                </div>

                <div class="button-group">
                    <button type="button" class="btn btn-primary" onclick="goToStep2()">
                        Continuar a Pago
                        <span class="material-icons">arrow_forward</span>
                    </button>
                </div>
            </form>
        </section>

        <!-- PASO 2: M√âTODO DE PAGO -->
        <section class="checkout-section" id="step2">
            <h2 class="section-title">
                <span class="material-icons" style="vertical-align: middle;">payment</span>
                M√©todo de Pago
            </h2>

            <div class="payment-methods">
                <label class="payment-option">
                    <input type="radio" name="metodo_pago" value="yape" checked>
                    <div class="payment-card">
                        <span class="material-icons">phone_android</span>
                        <span>Yape</span>
                    </div>
                </label>

                <label class="payment-option">
                    <input type="radio" name="metodo_pago" value="plin">
                    <div class="payment-card">
                        <span class="material-icons">phone_android</span>
                        <span>Plin</span>
                    </div>
                </label>

                <label class="payment-option">
                    <input type="radio" name="metodo_pago" value="tarjeta">
                    <div class="payment-card">
                        <span class="material-icons">credit_card</span>
                        <span>Tarjeta</span>
                    </div>
                </label>

                <label class="payment-option">
                    <input type="radio" name="metodo_pago" value="efectivo">
                    <div class="payment-card">
                        <span class="material-icons">payments</span>
                        <span>Efectivo</span>
                    </div>
                </label>
            </div>

            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="goToStep1()">
                    <span class="material-icons">arrow_back</span>
                    Volver
                </button>
                <button type="button" class="btn btn-primary" onclick="goToStep3()">
                    Ver Resumen
                    <span class="material-icons">arrow_forward</span>
                </button>
            </div>
        </section>

        <!-- PASO 3: RESUMEN DEL PEDIDO -->
        <section class="checkout-section" id="step3">
            <h2 class="section-title">
                <span class="material-icons" style="vertical-align: middle;">receipt_long</span>
                Resumen del Pedido
            </h2>

            <div id="summaryContent"></div>

            <div class="button-group">
                <button type="button" class="btn btn-secondary" onclick="goToStep2()">
                    <span class="material-icons">arrow_back</span>
                    Volver
                </button>
                <button type="button" class="btn btn-primary" onclick="placeOrder()">
                    <span class="material-icons">shopping_bag</span>
                    Confirmar Pedido
                </button>
            </div>
        </section>
    </div>

    <!-- QR MODAL -->
    <div id="qrModal" class="qr-modal">
        <div class="qr-content">
            <h2 id="qrTitle">Pagar con Yape</h2>
            <div class="qr-code">
                <span class="material-icons" style="font-size: 8rem; color: var(--primary);">qr_code_2</span>
            </div>
            <p><strong>Monto a pagar:</strong> <span id="qrAmount"></span></p>
            <p style="margin: 1rem 0; color: var(--text-light);">Escanea el c√≥digo con tu aplicaci√≥n</p>
            <div style="display: flex; gap: 0.5rem; align-items: center; margin: 1rem 0;">
                <input type="checkbox" id="qrConfirmation">
                <label for="qrConfirmation">He realizado el pago correctamente</label>
            </div>
            <div style="display: flex; gap: 1rem; justify-content: center; margin-top: 2rem;">
                <button class="btn btn-secondary" onclick="closeQRModal()">Cancelar</button>
                <button class="btn btn-primary" onclick="confirmQRPayment()">Confirmar</button>
            </div>
        </div>
    </div>

    <!-- SUCCESS MODAL -->
    <div id="successModal" class="success-modal">
        <div class="success-content">
            <span class="material-icons success-icon">check_circle</span>
            <h2>¬°Pedido Realizado Exitosamente!</h2>
            <p>Tu c√≥digo de pedido es:</p>
            <div class="order-code" id="orderCode">---</div>
            <p style="color: var(--text-light); margin: 1rem 0;">Recibir√°s un correo con los detalles</p>
            <button class="btn btn-primary" onclick="closeSuccessModal()">Entendido</button>
        </div>
    </div>

    <!-- TOAST -->
    <div id="toast" class="toast"></div>

    <script>
        // DATOS DE MUESTRA (simular carrito)
        const cartItems = [
            { id: 1, nombre: 'Comida Premium para Perros', cantidad: 2, precio: 45.00, imagen: 'üêï' },
            { id: 2, nombre: 'Juguete Interactivo', cantidad: 1, precio: 25.00, imagen: 'üéæ' }
        ];

        // DISTRITOS POR DEPARTAMENTO
        const distritosData = {
            'Lima': ['Lima', 'Miraflores', 'San Isidro', 'Surco', 'La Molina', 'San Borja', 'Jes√∫s Mar√≠a', 'Lince', 'San Miguel', 'Pueblo Libre', 'Magdalena', 'Los Olivos', 'San Mart√≠n de Porres', 'Independencia', 'Comas', 'Ate', 'Santa Anita', 'La Victoria', 'San Juan de Lurigancho', 'Villa El Salvador'],
            'Arequipa': ['Arequipa', 'Cayma', 'Cerro Colorado', 'Mariano Melgar', 'Miraflores', 'Paucarpata', 'Sachaca', 'Yanahuara', 'Jos√© Luis Bustamante y Rivero'],
            'Cusco': ['Cusco', 'Wanchaq', 'San Sebasti√°n', 'San Jer√≥nimo', 'Santiago'],
            'La Libertad': ['Trujillo', 'V√≠ctor Larco Herrera', 'Huanchaco', 'Moche', 'La Esperanza']
        };

        // STEP MANAGEMENT
        let currentStep = 1;
        const formData = {};

        function updateStepper(step) {
            document.querySelectorAll('.step').forEach((el, idx) => {
                const stepNum = idx + 1;
                el.classList.remove('active', 'completed');
                
                if (stepNum === step) {
                    el.classList.add('active');
                } else if (stepNum < step) {
                    el.classList.add('completed');
                }
            });
        }

        function showSection(step) {
            document.querySelectorAll('.checkout-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`step${step}`).classList.add('active');
            currentStep = step;
            updateStepper(step);
            window.scrollTo(0, 0);
        }

        // VALIDACIONES
        function validateNombre(nombre) {
            if (nombre.trim().length < 3) {
                return 'El nombre debe tener al menos 3 caracteres';
            }
            if (!/^[a-z√°√©√≠√≥√∫√±A-Z√Å√â√ç√ì√ö√ë\s]+$/.test(nombre)) {
                return 'Solo se permiten letras y espacios';
            }
            return null;
        }

        function validateTelefono(telefono) {
            if (!/^9\d{8}$/.test(telefono)) {
                return 'Debe ser un celular v√°lido (9 d√≠gitos, empieza con 9)';
            }
            return null;
        }

        function validateEmail(email) {
            if (!/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email)) {
                return 'Correo electr√≥nico inv√°lido';
            }
            return null;
        }

        function showError(fieldId, message) {
            const field = document.getElementById(fieldId);
            const errorEl = document.getElementById(`error-${fieldId}`);
            field.classList.add('error');
            errorEl.textContent = message;
            errorEl.classList.add('show');
        }

        function clearError(fieldId) {
            const field = document.getElementById(fieldId);
            const errorEl = document.getElementById(`error-${fieldId}`);
            field.classList.remove('error');
            errorEl.classList.remove('show');
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.className = `toast ${type} show`;
            toast.innerHTML = `
                <span class="material-icons">${type === 'success' ? 'check_circle' : type === 'error' ? 'error' : 'warning'}</span>
                <span>${message}</span>
            `;
            setTimeout(() => toast.classList.remove('show'), 4000);
        }

        // STEP 1: VALIDAR Y AVANZAR
        function goToStep2() {
            const nombre = document.getElementById('nombre').value.trim();
            const telefono = document.getElementById('telefono').value.trim();
            const email = document.getElementById('email').value.trim();
            const departamento = document.getElementById('departamento').value;
            const distrito = document.getElementById('distrito').value;
            const direccion = document.getElementById('direccion').value.trim();

            let isValid = true;

            // Limpiar errores
            ['nombre', 'telefono', 'email', 'departamento', 'distrito', 'direccion'].forEach(clearError);

            // Validar nombre
            const nombreError = validateNombre(nombre);
            if (nombreError) {
                showError('nombre', nombreError);
                isValid = false;
            }

            // Validar tel√©fono
            const telefonoError = validateTelefono(telefono);
            if (telefonoError) {
                showError('telefono', telefonoError);
                isValid = false;
            }

            // Validar email
            const emailError = validateEmail(email);
            if (emailError) {
                showError('email', emailError);
                isValid = false;
            }

            // Validar departamento
            if (!departamento) {
                showError('departamento', 'Selecciona un departamento');
                isValid = false;
            }

            // Validar distrito
            if (!distrito) {
                showError('distrito', 'Selecciona un distrito');
                isValid = false;
            }

            // Validar direcci√≥n
            if (direccion.length < 10) {
                showError('direccion', 'La direcci√≥n debe ser m√°s detallada (m√≠n. 10 caracteres)');
                isValid = false;
            }

            if (isValid) {
                formData.nombre = nombre;
                formData.telefono = telefono;
                formData.email = email;
                formData.departamento = departamento;
                formData.distrito = distrito;
                formData.direccion = direccion;
                showSection(2);
                showToast('Informaci√≥n guardada correctamente', 'success');
            } else {
                showToast('Por favor corrige los errores en el formulario', 'error');
            }
        }

        function goToStep1() {
            showSection(1);
        }

        // STEP 2: VALIDAR Y AVANZAR
        function goToStep3() {
            const metodoPago = document.querySelector('input[name="metodo_pago"]:checked');
            
            if (!metodoPago) {
                showToast('Selecciona un m√©todo de pago', 'warning');
                return;
            }

            formData.metodo_pago = metodoPago.value;
            generateSummary();
            showSection(3);
        }

        // STEP 3: GENERAR RESUMEN
        function generateSummary() {
            const subtotal = cartItems.reduce((sum, item) => sum + (item.cantidad * item.precio), 0);
            const envio = subtotal >= 100 ? 0 : 10;
            const total = subtotal + envio;

                            const summaryHTML = `
                <div style="background: var(--gray-light); padding: 1.5rem; border-radius: 10px; margin-bottom: 2rem;">
                    <h3 style="margin-bottom: 1rem; color: var(--text);">üìã Datos de Env√≠o</h3>
                    <p><strong>Nombre:</strong> ${formData.nombre}</p>
                    <p><strong>Tel√©fono:</strong> ${formData.telefono}</p>
                    <p><strong>Email:</strong> ${formData.email}</p>
                    <p><strong>Ubicaci√≥n:</strong> ${formData.distrito}, ${formData.departamento}</p>
                    <p><strong>Direcci√≥n:</strong> ${formData.direccion}</p>
                    <p style="margin-top: 1rem;"><strong>üí≥ M√©todo de Pago:</strong> ${getPaymentMethodName(formData.metodo_pago)}</p>
                </div>

                <h3 style="margin-bottom: 1rem;">üõí Productos</h3>
                <div class="summary-items">
                    ${cartItems.map(item => `
                        <div class="summary-item">
                            <div style="font-size: 2rem;">${item.imagen}</div>
                            <div class="summary-item-info">
                                <div style="font-weight: 600; margin-bottom: 0.3rem;">${item.nombre}</div>
                                <div style="color: var(--text-light); font-size: 0.9rem;">
                                    Cantidad: ${item.cantidad} x S/. ${item.precio.toFixed(2)}
                                </div>
                            </div>
                            <div style="font-weight: 700; color: var(--primary);">
                                S/. ${(item.cantidad * item.precio).toFixed(2)}
                            </div>
                        </div>
                    `).join('')}
                </div>

                <div class="summary-totals">
                    <div class="total-row">
                        <span>Subtotal:</span>
                        <span>S/. ${subtotal.toFixed(2)}</span>
                    </div>
                    <div class="total-row">
                        <span>Env√≠o:</span>
                        <span>${envio === 0 ? '<span style="color: var(--success); font-weight: 700;">GRATIS</span>' : 'S/. ' + envio.toFixed(2)}</span>
                    </div>
                    <div class="total-row total-final">
                        <span>Total a Pagar:</span>
                        <span>S/. ${total.toFixed(2)}</span>
                    </div>
                </div>
            `;

            document.getElementById('summaryContent').innerHTML = summaryHTML;
            formData.total = total;
        }

        function getPaymentMethodName(method) {
            const names = {
                'yape': 'üì± Yape',
                'plin': 'üì± Plin',
                'tarjeta': 'üí≥ Tarjeta de Cr√©dito/D√©bito',
                'efectivo': 'üíµ Efectivo (Contra entrega)'
            };
            return names[method] || method;
        }

        // REALIZAR PEDIDO
        function placeOrder() {
            const metodo = formData.metodo_pago;

            if (metodo === 'yape' || metodo === 'plin') {
                showQRModal(metodo);
            } else {
                processOrder();
            }
        }

        function showQRModal(metodo) {
            const modal = document.getElementById('qrModal');
            const title = document.getElementById('qrTitle');
            const amount = document.getElementById('qrAmount');

            title.textContent = metodo === 'yape' ? 'Pagar con Yape' : 'Pagar con Plin';
            amount.textContent = `S/. ${formData.total.toFixed(2)}`;
            
            document.getElementById('qrConfirmation').checked = false;
            modal.classList.add('active');
        }

        function closeQRModal() {
            document.getElementById('qrModal').classList.remove('active');
        }

        function confirmQRPayment() {
            const confirmed = document.getElementById('qrConfirmation').checked;

            if (!confirmed) {
                showToast('Por favor confirma que realizaste el pago', 'warning');
                return;
            }

            closeQRModal();
            processOrder();
        }

        function processOrder() {
            // Simular procesamiento
            showToast('Procesando pedido...', 'success');

            setTimeout(() => {
                const orderCode = 'PZ-' + new Date().getFullYear() + 
                                  (new Date().getMonth() + 1).toString().padStart(2, '0') + 
                                  new Date().getDate().toString().padStart(2, '0') + '-' + 
                                  Math.floor(Math.random() * 9999).toString().padStart(4, '0');

                document.getElementById('orderCode').textContent = orderCode;
                document.getElementById('successModal').classList.add('active');

                // Aqu√≠ normalmente enviar√≠as los datos al servidor
                console.log('Datos del pedido:', {
                    ...formData,
                    items: cartItems,
                    codigo: orderCode,
                    fecha: new Date().toISOString()
                });
            }, 1500);
        }

        function closeSuccessModal() {
            document.getElementById('successModal').classList.remove('active');
            // Redirigir a p√°gina principal o pedidos
            showToast('¬°Gracias por tu compra!', 'success');
            
            // Resetear formulario
            setTimeout(() => {
                location.reload();
            }, 1000);
        }

        // CARGAR DISTRITOS DIN√ÅMICAMENTE
        document.getElementById('departamento').addEventListener('change', function() {
            const departamento = this.value;
            const distritoSelect = document.getElementById('distrito');
            
            distritoSelect.disabled = !departamento;
            distritoSelect.innerHTML = '<option value="">Seleccionar distrito...</option>';

            if (departamento && distritosData[departamento]) {
                distritosData[departamento].forEach(distrito => {
                    const option = document.createElement('option');
                    option.value = distrito;
                    option.textContent = distrito;
                    distritoSelect.appendChild(option);
                });
            }

            clearError('departamento');
        });

        // VALIDACI√ìN EN TIEMPO REAL
        document.getElementById('nombre').addEventListener('input', function() {
            this.value = this.value.replace(/[^a-z√°√©√≠√≥√∫√±A-Z√Å√â√ç√ì√ö√ë\s]/g, '');
            clearError('nombre');
        });

        document.getElementById('telefono').addEventListener('input', function() {
            this.value = this.value.replace(/[^0-9]/g, '').slice(0, 9);
            clearError('telefono');
        });

        document.getElementById('email').addEventListener('blur', function() {
            clearError('email');
        });

        document.getElementById('distrito').addEventListener('change', function() {
            clearError('distrito');
        });

        document.getElementById('direccion').addEventListener('input', function() {
            clearError('direccion');
        });

        // PREVENIR ENV√çO CON ENTER (excepto textarea)
        document.getElementById('shippingForm').addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
            }
        });

        // INICIALIZACI√ìN
        console.log('‚úÖ Sistema de Checkout Cargado');
        console.log('üì¶ Items en carrito:', cartItems.length);
        console.log('üí∞ Total:', cartItems.reduce((sum, item) => sum + (item.cantidad * item.precio), 0).toFixed(2));
    </script>
</body>
</html>